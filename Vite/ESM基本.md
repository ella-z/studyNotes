# ESM基本
### ESM是什么
- ES modules（ESM） 是 JavaScript 官方的标准化模块系统。

### 为什么要模块化
- JS编程总得来说就是如何管理变量。
- 如果只有少量变量，组织起来并不困难，当代码量变大的时候，JS本身就提供了一种方式帮助你组织变量，称为函数作用域。但是因为函数作用域的缘故，一个函数无法访问另一个函数中定义的变量，那么就无法共享变量。在jQuery时代最常用的方法就是提升变量的作用域，将共享变量的作用域提升为全局作用域。这种方法会导致代码的后期维护变得困难，因为代码之间的依赖是不透明的，你也不知道哪个函数依赖了某个全局变量。其次，由于变量存在于全局作用域，所以任何的代码都有可能改变它。
- **模块化的作用**就是为你提供了一种更好的方式来组织变量和函数。
- 可以把相关的变量和函数放在一起组成一个模块，这种组织方式会把函数和变量放在一个模块作用域中，并且模块作用域还提供了一种暴露变量给其他模块使用的方式，模块可以明确地指定哪些变量、类或函数对外暴露。
- 对外暴露的过程称为导出。一旦导出，其他模块就可以引入其导出的变量、类或者函数。

### ESM原理
- 当使用模块进行开发时，构建一个依赖关系图，关系图中的连线代表了各个模块的引用关系，而关系图中的连线是根据代码中的导入语句形成的。
- 我们需要给浏览器或者Node一个入口(例如main.js)，从这个入口文件开始，浏览器或者Node就会顺着导入语句找出依赖的其他代码文件，然后解析文件成为模块记录的数据结构，之后需要将模块记录转换为模块实例，一个实例结合了两件事：代码和状态。
- 对于ES模块，分为三步进行：
   1. 构建：查找、下载所有文件并将其解析为模块记录。
   2. 实例化：为所有模块分配内存空间（此刻还没有填充值），然后依照导出、导入语句把模块指向对应的内存地址，这个过程称为链接（Linking）。
   3. 运行：运行代码，从而把内存空间填充为真实值。

### ESM的实现
- ESM有三种方式的实现：
   - 浏览器
   - webpack以及类似的构建工具
   - Node     

### 浏览器、ESM规范、模块化之间联系
#### 浏览器与JS
- 浏览器在渲染页面前会解析HTML文档，通过HTML解析器输出DOM元素和属性，然后构建DOM tree 和 CSSOM tree，这两个tree合并成渲染树， 然后用于计算每个可见元素的布局，并输出绘制流程，将像素渲染到屏幕上。
- 浏览器内核大部分分为两个部分：渲染引擎和JS引擎。
   - 渲染引擎：负责对网页语法的解释并渲染网页。例如webkit引擎、blink引擎。
   - JS引擎：是专用于对JS进行解释、编译和执行，使网页达到动态得到效果。例如V8引擎。    
#### 模块化与构建工具
- 为了系统更好的启动以及更新速度，构建模块工具需要实现分块传输，按需进行懒加载，当在实际用到模块的时候在增量更新。



### 参考
- [ES modules: A cartoon deep-dive](https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/)
- [图说 ES Modules](https://segmentfault.com/a/1190000014318751)
- [The state of JavaScript modules](https://medium.com/webpack/the-state-of-javascript-modules-4636d1774358)
- [JavaScript 模块现状](https://zhuanlan.zhihu.com/p/26567790)